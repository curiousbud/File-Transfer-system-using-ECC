{% extends "blog/base.html" %}

{% block title %}Qubix - Secure File Access{% endblock title %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-download mr-2"></i>
                        Secure File Access
                    </h3>
                    <p class="mb-0 mt-2 text-light">
                        Anonymous temporary file sharing
                    </p>
                </div>
                
                <div class="card-body">
                    <!-- File Information -->
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <i class="fas fa-file fa-3x text-primary"></i>
                        </div>
                        <h5>{{ temp_share.original_filename }}</h5>
                        <p class="text-muted">{{ temp_share.file_size|filesizeformat }}</p>
                    </div>

                    <!-- Access Information -->
                    <div class="alert alert-info" role="alert">
                        <div class="row text-center">
                            <div class="col-6">
                                <strong>Downloads Remaining</strong><br>
                                <span class="h4 {% if downloads_remaining <= 1 %}text-warning{% else %}text-success{% endif %}">
                                        <style>
                                        /* Hide scrollbars globally for this template */
                                        html {
                                            overflow: scroll;
                                            overflow-x: hidden;
                                        }
                                        ::-webkit-scrollbar {
                                            width: 0;  /* Remove scrollbar space */
                                            background: transparent;  /* Optional: just make scrollbar invisible */
                                        }
                                        /* Optional: show position indicator in red */
                                        ::-webkit-scrollbar-thumb {
                                            background: #FF0000;
                                        }
                                        </style>
                                    {{ downloads_remaining }}
                                </span>
                            </div>
                            <div class="col-6">
                                <strong>Expires In</strong><br>
                                <span class="h4 {% if expires_in_hours <= 1 %}text-danger{% elif expires_in_hours <= 6 %}text-warning{% else %}text-success{% endif %}">
                                    {% if expires_in_hours < 1 %}
                                        {{ expires_in_hours|floatformat:0 }} min
                                    {% else %}
                                        {{ expires_in_hours|floatformat:0 }}h
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    {% if password_required %}
                    <!-- Password Required Form -->
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="share_password" class="form-label">
                                <i class="fas fa-lock mr-1"></i>
                                <strong>Password Required</strong>
                            </label>
                            <input type="password" 
                                   class="form-control" 
                                   id="share_password" 
                                   name="share_password" 
                                   placeholder="Enter password to access file"
                                   required
                                   autofocus>
                            <small class="form-text text-muted">
                                This file is password protected. Enter the password shared with you.
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-unlock mr-2"></i>
                            Unlock & Download
                        </button>
                    </form>
                    {% else %}
                    <!-- Direct Download Form -->
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-block btn-lg">
                            <i class="fas fa-download mr-2"></i>
                            Download File
                        </button>
                    </form>
                    {% endif %}

                    <!-- Security Information -->
                    <div class="alert alert-secondary mt-4" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-shield-alt mr-1"></i>
                            Security Information
                        </h6>
                        <small>
                            • File is encrypted with <strong>{{ temp_share.algorithm }}</strong><br>
                            • Decryption happens in your browser<br>
                            • No personal information is required<br>
                            • Link expires automatically<br>
                            • Powered by Qubix secure sharing
                        </small>
                    </div>

                    <!-- Warning for Limited Access -->
                    {% if downloads_remaining <= 1 or expires_in_hours <= 6 %}
                    <div class="alert alert-warning" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Limited Access Warning
                        </h6>
                        {% if downloads_remaining <= 1 %}
                        <p class="mb-1">⚠️ This is the final download available for this file.</p>
                        {% endif %}
                        {% if expires_in_hours <= 6 %}
                        <p class="mb-0">⏰ This link will expire soon. Download now to avoid losing access.</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Powered by Qubix -->
            <div class="text-center mt-3">
                <small class="text-muted">
                    Secured by <strong>Qubix</strong> - Advanced ECC File Transfer System
                </small>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-focus on password field if required
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('share_password');
    if (passwordField) {
        passwordField.focus();
    }
});

// Update expiry countdown every minute
{% if expires_in_hours > 0 %}
setInterval(function() {
    location.reload();
}, 60000); // Refresh every minute to update countdown
{% endif %}
</script>
{% endblock content %}
